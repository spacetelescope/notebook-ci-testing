# Notebook CI - On-Demand Actions
# Copy this file to your repository's .github/workflows/ directory
# This workflow provides on-demand execution options with various configurations

name: Notebook CI - On-Demand Actions

on:
  workflow_dispatch:
    inputs:
      action_type:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - 'validate-all'
          - 'execute-all'
          - 'security-scan-all'
          - 'validate-single'
          - 'execute-single'
          - 'full-pipeline-all'
          - 'full-pipeline-single'
          - 'build-html-only'
          - 'deprecate-notebook'
          - 'generate-error-report'
        default: 'validate-all'
      
      single_notebook:
        description: 'Single notebook path (for single-notebook actions)'
        required: false
        type: string
        
      python_version:
        description: 'Python version'
        required: false
        type: string
        default: '3.11'
        
      conda_environment:
        description: 'Custom conda environment (optional)'
        required: false
        type: string
        
      deprecation_days:
        description: 'Days until deprecation (for deprecate action)'
        required: false
        type: string
        default: '60'
        
      enable_debug:
        description: 'Enable debug logging'
        required: false
        type: boolean
        default: false
      
      report_workflow:
        description: 'Workflow to analyze for error report (scheduled, main-branch, on-demand, pull-request, or all)'
        required: false
        type: string
        default: 'all'
      
      report_runs:
        description: 'Number of recent runs to analyze'
        required: false
        type: string
        default: '10'
      
      report_include_logs:
        description: 'Include detailed error logs in report'
        required: false
        type: boolean
        default: false

jobs:
  validate-all:
    if: inputs.action_type == 'validate-all'
    uses:  spacetelescope/notebook-ci-actions/.github/workflows/notebook-ci-unified.yml@jbv2Testing
    with:
      execution-mode: 'on-demand'
      trigger-event: 'validate'
      python-version: ${{ inputs.python_version }}
      conda-environment: ${{ inputs.conda_environment }}
      enable-validation: true
      enable-security: false
      enable-execution: false
      enable-storage: false
      enable-html-build: false
      custom-runner-config: true  # Enable ci_config.txt lookup
    secrets:
      CASJOBS_USERID: ${{ secrets.CASJOBS_USERID }}
      CASJOBS_PW: ${{ secrets.CASJOBS_PW }}

  execute-all:
    if: inputs.action_type == 'execute-all'  
    uses: spacetelescope/notebook-ci-actions/.github/workflows/notebook-ci-unified.yml@jbv2Testing
    with:
      execution-mode: 'on-demand'
      trigger-event: 'execute'
      python-version: ${{ inputs.python_version }}
      conda-environment: ${{ inputs.conda_environment }}
      enable-validation: false
      enable-security: false
      enable-execution: true
      enable-storage: false
      enable-html-build: false
      custom-runner-config: true  # Enable ci_config.txt lookup
    secrets:
      CASJOBS_USERID: ${{ secrets.CASJOBS_USERID }}
      CASJOBS_PW: ${{ secrets.CASJOBS_PW }}

  security-scan-all:
    if: inputs.action_type == 'security-scan-all'
    uses:  spacetelescope/notebook-ci-actions/.github/workflows/notebook-ci-unified.yml@jbv2Testing
    with:
      execution-mode: 'on-demand'
      trigger-event: 'security'
      python-version: ${{ inputs.python_version }}
      conda-environment: ${{ inputs.conda_environment }}
      enable-validation: false
      enable-security: true
      enable-execution: false
      enable-storage: false
      enable-html-build: false
    secrets:
      CASJOBS_USERID: ${{ secrets.CASJOBS_USERID }}
      CASJOBS_PW: ${{ secrets.CASJOBS_PW }}

  validate-single:
    if: inputs.action_type == 'validate-single'
    uses:  spacetelescope/notebook-ci-actions/.github/workflows/notebook-ci-unified.yml@jbv2Testing
    with:
      execution-mode: 'on-demand'
      trigger-event: 'validate'
      single-notebook: ${{ inputs.single_notebook }}
      python-version: ${{ inputs.python_version }}
      conda-environment: ${{ inputs.conda_environment }}
      enable-validation: true
      enable-security: false
      enable-execution: false
      enable-storage: false
      enable-html-build: false
      custom-runner-config: true  # Enable ci_config.txt lookup
    secrets:
      CASJOBS_USERID: ${{ secrets.CASJOBS_USERID }}
      CASJOBS_PW: ${{ secrets.CASJOBS_PW }}

  execute-single:
    if: inputs.action_type == 'execute-single'
    uses:  spacetelescope/notebook-ci-actions/.github/workflows/notebook-ci-unified.yml@jbv2Testing
    with:
      execution-mode: 'on-demand'
      trigger-event: 'execute'
      single-notebook: ${{ inputs.single_notebook }}
      python-version: ${{ inputs.python_version }}
      conda-environment: ${{ inputs.conda_environment }}
      enable-validation: false
      enable-security: false
      enable-execution: true
      enable-storage: false
      enable-html-build: false
      custom-runner-config: true  # Enable ci_config.txt lookup
    secrets:
      CASJOBS_USERID: ${{ secrets.CASJOBS_USERID }}
      CASJOBS_PW: ${{ secrets.CASJOBS_PW }}

  full-pipeline-all:
    if: inputs.action_type == 'full-pipeline-all'
    uses:  spacetelescope/notebook-ci-actions/.github/workflows/notebook-ci-unified.yml@jbv2Testing
    with:
      execution-mode: 'on-demand'
      trigger-event: 'all'
      python-version: ${{ inputs.python_version }}
      conda-environment: ${{ inputs.conda_environment }}
      enable-validation: true
      enable-security: true
      enable-execution: true
      enable-storage: true
      enable-html-build: true
      custom-runner-config: true  # Enable ci_config.txt lookup
    secrets:
      CASJOBS_USERID: ${{ secrets.CASJOBS_USERID }}
      CASJOBS_PW: ${{ secrets.CASJOBS_PW }}

  full-pipeline-single:
    if: inputs.action_type == 'full-pipeline-single'
    uses:  spacetelescope/notebook-ci-actions/.github/workflows/notebook-ci-unified.yml@jbv2Testing
    with:
      execution-mode: 'on-demand'
      trigger-event: 'all'
      single-notebook: ${{ inputs.single_notebook }}
      python-version: ${{ inputs.python_version }}
      conda-environment: ${{ inputs.conda_environment }}
      enable-validation: true
      enable-security: true
      enable-execution: true
      enable-storage: true
      enable-html-build: true
      custom-runner-config: true  # Enable ci_config.txt lookup
    secrets:
      CASJOBS_USERID: ${{ secrets.CASJOBS_USERID }}
      CASJOBS_PW: ${{ secrets.CASJOBS_PW }}

  build-html-only:
    if: inputs.action_type == 'build-html-only'
    uses:  spacetelescope/notebook-ci-actions/.github/workflows/notebook-ci-unified.yml@jbv2Testing
    with:
      execution-mode: 'on-demand'
      trigger-event: 'html'
      python-version: ${{ inputs.python_version }}
      enable-validation: false
      enable-security: false
      enable-execution: false
      enable-storage: false
      enable-html-build: true
    secrets:
      CASJOBS_USERID: ${{ secrets.CASJOBS_USERID }}
      CASJOBS_PW: ${{ secrets.CASJOBS_PW }}

  deprecate-notebook:
    if: inputs.action_type == 'deprecate-notebook'
    uses: spacetelescope/notebook-ci-actions/.github/workflows/notebook-ci-unified.yml@jbv2Testing
    with:
      execution-mode: 'on-demand'
      trigger-event: 'deprecate'
      single-notebook: ${{ inputs.single_notebook }}
      python-version: ${{ inputs.python_version }}
      deprecation-days: ${{ fromJSON(inputs.deprecation_days) }}
      enable-validation: false
      enable-security: false
      enable-execution: false
      enable-storage: false
      enable-html-build: false
    secrets:
      CASJOBS_USERID: ${{ secrets.CASJOBS_USERID }}
      CASJOBS_PW: ${{ secrets.CASJOBS_PW }}

  performance-test:
    if: inputs.action_type == 'performance-test'
    uses:  spacetelescope/notebook-ci-actions/.github/workflows/notebook-ci-unified.yml@jbv2Testing
    with:
      execution-mode: 'on-demand'
      trigger-event: 'all'
      python-version: ${{ inputs.python_version }}
      conda-environment: ${{ inputs.conda_environment }}
      enable-validation: true
      enable-security: true
      enable-execution: true
      enable-storage: false  # Skip storage for performance testing
      enable-html-build: false
      custom-runner-config: true  # Enable ci_config.txt lookup
    secrets:
      CASJOBS_USERID: ${{ secrets.CASJOBS_USERID }}
      CASJOBS_PW: ${{ secrets.CASJOBS_PW }}

  generate-error-report:
    if: inputs.action_type == 'generate-error-report'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
      
      - name: Install dependencies
        run: |
          pip install -r requirements-reporting.txt
      
      - name: Generate error report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Build command with options
          CMD="python generate_error_report.py --output error_report.md --runs ${{ inputs.report_runs }}"
          
          # Add workflow filter if not 'all'
          if [ "${{ inputs.report_workflow }}" != "all" ]; then
            CMD="$CMD --workflow ${{ inputs.report_workflow }}"
          fi
          
          # Add log inclusion if requested
          if [ "${{ inputs.report_include_logs }}" == "true" ]; then
            CMD="$CMD --include-logs"
          fi
          
          echo "Running: $CMD"
          $CMD
      
      - name: Upload error report
        uses: actions/upload-artifact@v4
        with:
          name: notebook-error-report
          path: error_report.md
          retention-days: 30
      
      - name: Display report summary
        run: |
          echo "## Error Report Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The error report has been generated and uploaded as an artifact." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow(s): ${{ inputs.report_workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- Runs analyzed: ${{ inputs.report_runs }}" >> $GITHUB_STEP_SUMMARY
          echo "- Include logs: ${{ inputs.report_include_logs }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Preview" >> $GITHUB_STEP_SUMMARY
          head -50 error_report.md >> $GITHUB_STEP_SUMMARY

