name: Notebook Accessibility Scan - Matrix

on:
  workflow_call:
    inputs:
      notebooks-pattern:
        description: 'Glob pattern for notebooks to scan'
        required: false
        type: string
        default: 'notebooks/*/*/*.ipynb'

jobs:
  discover-notebooks:
    name: Discover Notebooks
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      notebooks: ${{ steps.set-matrix.outputs.notebooks }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Discover notebooks and build matrix
        id: set-matrix
        shell: bash
        run: |
          # Find all notebooks matching the pattern
          notebooks=$(find . -path "./.git" -prune -o -name "*.ipynb" -type f -print | grep -E "${{ inputs.notebooks-pattern }}" | sort | jq -R -s -c 'split("\n")[:-1]')
          
          echo "notebooks=$notebooks" >> $GITHUB_OUTPUT
          
          # Build matrix JSON for GitHub Actions
          matrix_json=$(echo "$notebooks" | jq -c '{include: [.[] | {notebook: .}]}')
          
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          
          # Display what was found
          echo "ðŸ“‹ Discovered notebooks:"
          echo "$notebooks" | jq -r '.[]' || echo "No notebooks found"

  a11y-scan:
    name: Scan ${{ matrix.notebook }} for Accessibility Issues
    runs-on: ubuntu-latest
    needs: discover-notebooks
    strategy:
      matrix: ${{ fromJson(needs.discover-notebooks.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan notebook for accessibility issues
        uses: berkeley-dsep-infra/jupyterlab-a11y-checker@main
        with:
          files: ${{ matrix.notebook }}
        continue-on-error: true

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: a11y-results-${{ matrix.notebook }}
          path: |
            a11y-*.json
            a11y-*.html
          retention-days: 30
        continue-on-error: true

  a11y-summary:
    name: Accessibility Scan Summary
    runs-on: ubuntu-latest
    needs: a11y-scan
    if: always()

    steps:
      - name: Download all scan results
        uses: actions/download-artifact@v3
        with:
          path: scan-results
        continue-on-error: true

      - name: Summarize scan results
        shell: bash
        run: |
          echo "## ðŸ“Š Accessibility Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "scan-results" ] && [ "$(find scan-results -type f | wc -l)" -gt 0 ]; then
            echo "âœ… Scan artifacts collected:" >> $GITHUB_STEP_SUMMARY
            find scan-results -type f -name "*.json" -o -name "*.html" | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No scan artifacts found" >> $GITHUB_STEP_SUMMARY
          fi

